#!/bin/bash
set -e # exit when error

echo "\033[32m ğŸ„ Start processing build.sh"

. ~/.nvm/nvm.sh
nvm install v6
nvm use v6

npm i -g npm
npm set registry https://registry.npmjs.org/

test -f ../mtk-ui-nm-cache.tar && tar xf ../mtk-ui-nm-cache.tar
NODE_ENV=development npm prune
NODE_ENV=development npm install
npm update
tar cf ../mtk-ui-nm-cache.tar node_modules

cd example

test -f ../../mtk-ui-example-nm-cache.tar && tar xf ../../mtk-ui-example-nm-cache.tar
npm prune
NODE_ENV=development npm install
npm update
tar cf ../../mtk-ui-example-nm-cache.tar node_modules

cd ../

npm run check:env
npm run lint
npm run test
npm run build

echo "\033[32m ğŸ„ Start packing"

rm -f *.tgz
npm pack

echo "\033[32m ğŸ„ Start publishing"

VERSION=$(node -p -e "require('./package.json').version")
mv *.tgz package.tgz

if [ ${BRANCHNAME} != "master" ]; then
 echo "It is not the master branch, the package will not be released."
 exit 0
elif [ -e "/home/ubuntu/storage/packages/mtk-ui/${VERSION}.tgz" ]; then
 echo "${VERSION}.tgz exists"
 exit 1
else
  mv package.tgz /home/ubuntu/storage/packages/mtk-ui/${VERSION}.tgz
fi


echo "\033[32m ğŸ„ Start building the example page"

cd example
npm run build
cd ../
tar -zcvf mtk-ui-release.tar.gz example/build coverage package.json

echo "\033[32m ğŸ„ Finish processing build.sh"
